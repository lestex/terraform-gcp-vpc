env: &docker    
  docker:
    - image: leandevopsio/terratest:0.3

version: 2
jobs:
  check_terraform:
    <<: *docker
    steps:
      - checkout      
      - run:
          name: terraform init
          command: find . -type f -name "*.tf" -exec dirname {} \;|sort -u | while read m; do (cd "$m" && terraform init -input=false -backend=false) || exit 1; done
      - run:
          name: Validate Terraform configurations
          command: find . -name ".terraform" -prune -o -type f -name "*.tf" -exec dirname {} \;|sort -u | while read m; do (cd "$m" && terraform validate && echo "âˆš $m") || exit 1 ; done
      - run:
          name: Check if Terraform configurations are properly formatted
          command: if [[ -n "$(terraform fmt -write=false)" ]]; then echo "Some terraform files need be formatted, run 'terraform fmt' to fix"; exit 1; fi
      - run:
          name: Check Terraform configurations with tflint
          command: tflint
  # run-tests:
  #   <<: *docker
  #   environment:
  #     BUNDLE_PATH: vendor

  #   steps:
  #     - checkout
  #     - restore_cache:
  #         keys:
  #           - tf-gcp-network-{{ checksum "Gemfile.lock" }}

  #     - run:
  #         name: Bundle Install
  #         command: bundle check || bundle install
      
  #     - save_cache:
  #         key: tf-gcp-network-{{ checksum "Gemfile.lock" }}
  #         paths:
  #           - vendor

  #     - run:
  #         name: Run make to zip a function code
  #         command: make build

  #     - run:
  #         name: Run rspec test
  #         command: make

workflows:
  version: 2
  tf-workflow:
    jobs:      
      - check_terraform
      # - check_tflint:
      #     requires:
      #       - check_terraform
      # - request-run:
      #     type: approval
      #     requires:
      #       - terraform-validate
      #       - terraform-fmt
      #       - tflint
      #     filters:
      #       branches:
      #         ignore: master
      # - run-tests:
      #     requires:
      #       - request-run
      #     filters:
      #       branches:
      #         ignore: master